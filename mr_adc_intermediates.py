import numpy as np

def compute_K_ac(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    # Computing K_ac
    K_ac  = einsum('XY->XY', h_aa, optimize = einsum_type).copy()
    # K_ac -= 1/2 * einsum('Yx,xX->XY', h_aa, rdm_ca, optimize = einsum_type)
    K_ac += einsum('XxYy,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K_ac -= 1/2 * einsum('XxyY,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K_ac -= 1/2 * einsum('Yxyz,yzXx->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    return K_ac

def compute_K_ca(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    # Computing K_ca
    K_ca =- 1/2 * einsum('Yx,Xx->XY', h_aa, rdm_ca, optimize = einsum_type)
    K_ca -= 1/2 * einsum('Yxyz,Xxyz->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    return K_ca

def compute_K_aacc(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas
    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    # Computing K_aacc
    K_aacc  = einsum('WZXY->ZWYX', v_aaaa, optimize = einsum_type).copy()
    K_aacc += einsum('WX,YZ->ZWYX', h_aa, np.identity(ncas), optimize = einsum_type)
    K_aacc += einsum('YZ,WX->ZWYX', h_aa, np.identity(ncas), optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,YZ->ZWYX', h_aa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/6 * einsum('Xx,YxWZ->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('Xx,YxZW->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,XW->ZWYX', h_aa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/3 * einsum('Yx,XxWZ->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('Yx,XxZW->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WZXx,Yx->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WZxY,Xx->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WxXY,xZ->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WxXy,YxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('WxyX,YxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('WxyX,YxyZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('WxyY,XxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('WxyY,XxyZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('XYxZ,xW->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/3 * einsum('XYxy,xyWZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('XYxy,xyZW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('XxyZ,YyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('XxyZ,YyxW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/12 * einsum('Xxyz,YyzWZx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzWxZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc += 1/4 * einsum('Xxyz,YyzZWx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzZxW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzxWZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzxZW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YxZy,XyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('YxyZ,XyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('YxyZ,XyxW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/4 * einsum('Yxyz,XyzWZx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzWxZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc += 1/12 * einsum('Yxyz,XyzZWx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzZxW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzxWZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzxZW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('Xx,YZ,xW->ZWYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('Yx,WX,xZ->ZWYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_aacc += einsum('WX,YxZy,yx->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,YxyZ,yx->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,Yxyz,yzZx->ZWYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += einsum('YZ,WxXy,xy->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,WxyX,xy->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,Xxyz,yzWx->ZWYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    return K_aacc

def compute_K_ccaa(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    # Computing K_ccaa
    K_ccaa =- 1/6 * einsum('Wx,XYZx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('Wx,XYxZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('Zx,XYWx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/6 * einsum('Zx,XYxW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('WZxy,XYxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/6 * einsum('WZxy,XYyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/12 * einsum('Wxyz,XYxZyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxZzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/4 * einsum('Wxyz,XYxyZz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxyzZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxzZy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxzyZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/4 * einsum('Zxyz,XYxWyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxWzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/12 * einsum('Zxyz,XYxyWz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxyzW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxzWy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxzyW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    return K_ccaa

def compute_K_p1p_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    n_x = ncas * 2
    n_xzw = ncas * 2 * ncas * 2 * (ncas * 2 - 1) // 2
    dim_act = n_x + n_xzw
    aa_ind = np.tril_indices(ncas * 2, k=-1)

    # Computing K11
    K11 = np.zeros((ncas * 2, ncas * 2))

    K11_a_a  = einsum('XY->XY', h_aa, optimize = einsum_type).copy()
    # K11_a_a -= 1/2 * einsum('Yx,xX->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a += einsum('XxYy,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('XxyY,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,yzXx->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    K11[::2,::2] = K11_a_a.copy()
    K11[1::2,1::2] = K11_a_a.copy()

    # Computing K12
    K12 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K12_a_bba =- 1/3 * einsum('Wx,YxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Wx,YxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,WZ->XZWY', h_aa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Yx,WxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('Yx,WxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('Zx,WYXx->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('Zx,WYxX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('WYxX,xZ->XZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WYxy,xyXZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WYxy,xyZX->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WxyX,YyZx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WxyX,YyxZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Wxyz,YyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Wxyz,YyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('XZxy,WYxy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('XZxy,WYyx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XxYy,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('XxyY,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('XxyY,WxyZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Yxyz,WyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WYxXyz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxXzy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/4 * einsum('Zxyz,WYxyXz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxyzX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzXy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzyX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('Wx,XY,xZ->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('Zx,XY,Wx->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,Wxyz,yzZx->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('XY,Zxyz,Wxyz->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K12[::2,1::2,1::2,::2] = K12_a_bba.copy()
    K12[1::2,::2,::2,1::2] = K12[::2,1::2,1::2,::2].copy()

    K12[::2,1::2,::2,1::2] -= K12_a_bba.transpose(0,1,3,2).copy()
    K12[1::2,::2,1::2,::2]  = K12[::2,1::2,::2,1::2].copy()

    K12[::2,::2,::2,::2]  = K12_a_bba.copy()
    K12[::2,::2,::2,::2] += K12[::2,1::2,::2,1::2].copy()
    K12[1::2,1::2,1::2,1::2] = K12[::2,::2,::2,::2].copy()

    # Computing K22
    K22 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K22_aab_aab =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,UYxVXZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxyW,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 3/10 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 2/15 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 11/40 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/15 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Wxyz,UYyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Wxyz,UYyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XxYy,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxyY,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 9/40 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/5 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/120 * einsum('Yxyz,UWyzZXVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzZXxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UWyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/10 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 2/15 * einsum('Zxyz,UWYxXVyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 11/40 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxyXVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Zxyz,UWYxzXVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxzXyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UWYxzyXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22_baa_baa =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,UWXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,UWZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,UYVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,UYZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,UYxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VXYW,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXYx,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXYx,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXxW,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXxW,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYW,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VxYW,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYy,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxyW,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WYXx,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WYXx,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxXy,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/40 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 2/15 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/10 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Wxyz,UYyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Wxyz,UYyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxyY,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 11/40 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 2/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/10 * einsum('Yxyz,UWyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UWyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/120 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/120 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UWYxyVXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WX,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Wx,VY,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Wx,VY,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,WX,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Yx,WX,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,VY,UWXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,VY,UWxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,WX,UYVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,WX,UYxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WxXy,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,WxyX,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,WxyX,UyxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Wxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VY,Wxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VY,XZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VY,XZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Zxyz,UWxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VY,Zxyz,UWxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WX,VZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WX,VZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,VxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,VxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Yxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('WX,Yxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Zxyz,UYxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('WX,Zxyz,UYxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zx,VY,WX,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zxyz,VY,WX,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    K22[::2,1::2,::2,::2,1::2,::2] = K22_aab_aab.transpose(0,2,1,3,5,4).copy()
    K22[1::2,::2,1::2,1::2,::2,1::2] = K22[::2,1::2,::2,::2,1::2,::2].copy()

    K22[::2,1::2,::2,::2,::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    K22[1::2,::2,1::2,1::2,1::2,::2] = K22[::2,1::2,::2,::2,::2,1::2].copy()

    K22[::2,::2,1::2,::2,1::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,::2,1::2,::2,1::2] = K22[::2,::2,1::2,::2,1::2,::2].copy()

    K22[::2,::2,::2,1::2,1::2,::2]  = K22_aab_aab.copy()
    K22[::2,::2,::2,1::2,1::2,::2] -= K22_baa_baa.copy()
    K22[::2,::2,::2,1::2,1::2,::2] += K22[::2,1::2,::2,::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,::2,::2,1::2] = K22[::2,::2,::2,1::2,1::2,::2].copy()

    K22[1::2,1::2,::2,::2,::2,::2]  = K22_aab_aab.copy()
    K22[1::2,1::2,::2,::2,::2,::2] -= K22_baa_baa.copy()
    K22[1::2,1::2,::2,::2,::2,::2] += K22[::2,::2,1::2,::2,1::2,::2].copy()
    K22[::2,::2,1::2,1::2,1::2,1::2] = K22[1::2,1::2,::2,::2,::2,::2].copy()

    K22[1::2,::2,1::2,::2,::2,::2] -= K22[1::2,1::2,::2,::2,::2,::2].transpose(0,2,1,3,4,5).copy()
    K22[::2,1::2,::2,1::2,1::2,1::2] = K22[1::2,::2,1::2,::2,::2,::2].copy()

    K22[::2,::2,::2,1::2,::2,1::2] -= K22[::2,::2,::2,1::2,1::2,::2].transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,1::2,::2,1::2,::2] = K22[::2,::2,::2,1::2,::2,1::2].copy()

    K22[::2,::2,::2,::2,::2,::2]  = K22[::2,::2,::2,1::2,1::2,::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,1::2,::2,1::2,::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,::2,1::2,1::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,1::2,1::2,1::2] = K22[::2,::2,::2,::2,::2,::2].copy()

    K12 = K12[:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,:,:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,aa_ind[0],aa_ind[1]]

    K_p1p = np.zeros((dim_act, dim_act))

    K_p1p[:n_x,:n_x] = K11.copy()
    K_p1p[:n_x,n_x:] = K12.reshape(n_x, n_xzw).copy()
    K_p1p[n_x:,:n_x] = K12.reshape(n_x, n_xzw).T.copy()
    K_p1p[n_x:,n_x:] = K22.reshape(n_xzw, n_xzw).copy()

    return K_p1p

def compute_K_m1p_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    n_x = ncas * 2
    n_xzw = ncas * 2 * ncas * 2 * (ncas * 2 - 1) // 2
    dim_act = n_x + n_xzw
    aa_ind = np.tril_indices(ncas * 2, k=-1)

    # Computing K11
    K11 = np.zeros((ncas * 2, ncas * 2))

    K11_a_a =- 1/2 * einsum('Yx,Xx->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,Xxyz->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    K11[::2,::2] = K11_a_a.copy()
    K11[1::2,1::2] = K11_a_a.copy()

    # Computing K12
    K12 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K12_a_abb =- 1/3 * einsum('Wx,XZYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Wx,XZxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Yx,XZWx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('Yx,XZxW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/6 * einsum('Zx,XxWY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/3 * einsum('Zx,XxYW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('WYxy,XZxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('WYxy,XZyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Wxyz,XZxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Wxyz,XZxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Yxyz,XZxWyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxWzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Yxyz,XZxyWz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxyzW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzWy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzyW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Zxyz,XyzWYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzWxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/4 * einsum('Zxyz,XyzYWx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzYxW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxWY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxYW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K12[::2,::2,1::2,1::2] = K12_a_abb.copy()
    K12[1::2,1::2,::2,::2] = K12_a_abb.copy()

    K12[::2,1::2,::2,1::2] -= K12[::2,::2,1::2,1::2].transpose(0,2,1,3).copy()
    K12[1::2,::2,1::2,::2]  = K12[::2,1::2,::2,1::2].copy()

    K12[::2,::2,::2,::2]  = K12_a_abb.copy()
    K12[::2,::2,::2,::2] += K12[::2,1::2,::2,1::2].copy()
    K12[1::2,1::2,1::2,1::2] = K12[::2,::2,::2,::2].copy()

    # Computing K22
    K22 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K22_aab_aab  = 1/6 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,UXZYxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,UXZWxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,UXxWYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxyZ,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 2/15 * einsum('Wxyz,UXZxVYyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UXZxVYzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 11/40 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/60 * einsum('Wxyz,UXZxVyzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Wxyz,UXZxVzyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/20 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/10 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/40 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Wxyz,UXZxyYzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Wxyz,UXZxyzYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Wxyz,UXZxzVyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/40 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 2/15 * einsum('Yxyz,UXZxVWyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UXZxVWzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 11/40 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Yxyz,UXZxVyzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UXZxVzyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/10 * einsum('Yxyz,UXZxWyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Yxyz,UXZxWyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UXZxWzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UXZxWzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UXZxyzWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Yxyz,UXZxzVyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Yxyz,UXZxzyWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Zxyz,UXyzVWYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UXyzVWxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Zxyz,UXyzVYWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UXyzVYxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 9/40 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UXyzWYVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UXyzWYxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/5 * einsum('Zxyz,UXyzWxVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Zxyz,UXyzWxYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/120 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22_baa_baa  = 1/3 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,UXZVYx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,UXZWxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,UXxWYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxyZ,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 3/10 * einsum('Wxyz,UXZxVYyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UXZxVYzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/20 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UXZxVyzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Wxyz,UXZxVzyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/40 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 2/15 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 7/60 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/40 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Wxyz,UXZxyVzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Wxyz,UXZxyzVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/40 * einsum('Wxyz,UXZxzVyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yxyz,UXZxVWzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Yxyz,UXZxVyzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/20 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Yxyz,UXZxVzyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/120 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/120 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UXZxyVzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Yxyz,UXZxyWVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Yxyz,UXZxyzVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UXZxzVyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 2/15 * einsum('Zxyz,UXyzVWYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Zxyz,UXyzVWxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/10 * einsum('Zxyz,UXyzVYWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UXyzVYxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 11/40 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Zxyz,UXyzYWVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Zxyz,UXyzYWxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/40 * einsum('Zxyz,UXyzYxVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxYzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxyzY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxzYy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxzyY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxWzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxyzW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxzWy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxzyW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    K22[1::2,::2,::2,::2,1::2,::2] -= K22_baa_baa.transpose(0,1,2,4,3,5).copy()
    K22[::2,1::2,1::2,1::2,::2,1::2] = K22[1::2,::2,::2,::2,1::2,::2].copy()

    K22[::2,1::2,::2,1::2,::2,::2] -= K22_baa_baa.transpose(1,0,2,3,4,5).copy()
    K22[1::2,::2,1::2,::2,1::2,1::2] = K22[::2,1::2,::2,1::2,::2,::2].copy()

    K22[::2,1::2,::2,::2,1::2,::2] = K22_baa_baa.transpose(1,0,2,4,3,5).copy()
    K22[1::2,::2,1::2,1::2,::2,1::2] = K22[::2,1::2,::2,::2,1::2,::2].copy()

    K22[::2,::2,::2,::2,1::2,1::2]  = K22_baa_baa.copy()
    K22[::2,::2,::2,::2,1::2,1::2] -= K22_aab_aab.copy()
    K22[::2,::2,::2,::2,1::2,1::2] += K22[::2,1::2,::2,1::2,::2,::2].copy()
    K22[1::2,1::2,1::2,1::2,::2,::2] = K22[::2,::2,::2,::2,1::2,1::2].copy()

    K22[::2,::2,::2,1::2,::2,1::2] -= K22[::2,::2,::2,::2,1::2,1::2].transpose(0,1,2,4,3,5).copy()
    K22[1::2,1::2,1::2,::2,1::2,::2] = K22[::2,::2,::2,1::2,::2,1::2].copy()

    K22[::2,1::2,1::2,::2,::2,::2]  = K22_baa_baa.copy()
    K22[::2,1::2,1::2,::2,::2,::2] -= K22_aab_aab.copy()
    K22[::2,1::2,1::2,::2,::2,::2] += K22[1::2,::2,::2,::2,1::2,::2].copy()
    K22[1::2,::2,::2,1::2,1::2,1::2] = K22[::2,1::2,1::2,::2,::2,::2].copy()

    K22[1::2,::2,1::2,::2,::2,::2] -= K22[::2,1::2,1::2,::2,::2,::2].transpose(1,0,2,3,4,5).copy()
    K22[::2,1::2,::2,1::2,1::2,1::2] = K22[1::2,::2,1::2,::2,::2,::2].copy()

    K22[::2,::2,::2,::2,::2,::2]  = K22[::2,::2,::2,::2,1::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[::2,1::2,1::2,1::2,::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,::2,1::2,1::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,1::2,1::2,1::2] = K22[::2,::2,::2,::2,::2,::2].copy()

    K12 = K12[:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[aa_ind[0],aa_ind[1]]

    K_m1p = np.zeros((dim_act, dim_act))

    K_m1p[:n_x,:n_x] = K11.copy()
    K_m1p[:n_x,n_x:] = K12.reshape(n_x, n_xzw).copy()
    K_m1p[n_x:,:n_x] = K12.reshape(n_x, n_xzw).T.copy()
    K_m1p[n_x:,n_x:] = K22.reshape(n_xzw, n_xzw).copy()

    return K_m1p

def compute_K_caca_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    K_caca = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K_caca_ab_ba  = 1/2 * einsum('WY,XZ->XYWZ', h_aa, rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/2 * einsum('WxYy,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/4 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/4 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('Zx,WY,Xx->XYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('WY,Zxyz,Xxyz->XYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K_caca_aa_bb  = 1/3 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/3 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/4 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/4 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K_caca[::2,1::2,1::2,::2] = K_caca_ab_ba.copy()
    K_caca[1::2,::2,::2,1::2] = K_caca_ab_ba.copy()

    K_caca[::2,::2,1::2,1::2] = K_caca_aa_bb.copy()
    K_caca[1::2,1::2,::2,::2] = K_caca_aa_bb.copy()

    K_caca[::2,::2,::2,::2]  = K_caca_ab_ba.copy()
    K_caca[::2,::2,::2,::2] += K_caca_aa_bb.copy()
    K_caca[1::2,1::2,1::2,1::2] = K_caca[::2,::2,::2,::2].copy()

    return K_caca

## Under Development
def compute_K_caca_test(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    K_caca = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K_caca_ab_ba  = 1/2 * einsum('WY,XZ->XYWZ', h_aa, rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/2 * einsum('WxYy,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/4 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/4 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('Zx,WY,Xx->XYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('WY,Zxyz,Xxyz->XYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K_caca_aa_bb  = 1/3 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/3 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/4 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/4 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    # K_caca[::2,1::2,1::2,::2] = K_caca_ab_ba.copy()
    # K_caca[1::2,::2,::2,1::2] = K_caca_ab_ba.copy()

    K_caca[::2,::2,1::2,1::2] = K_caca_aa_bb.copy()
    K_caca[1::2,1::2,::2,::2] = K_caca_aa_bb.copy()

    K_caca[::2,::2,::2,::2]  = K_caca_ab_ba.copy()
    K_caca[::2,::2,::2,::2] += K_caca_aa_bb.copy()
    K_caca[1::2,1::2,1::2,1::2] = K_caca[::2,::2,::2,::2].copy()

    return K_caca

def compute_K_p1p_test(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    n_x = ncas * 2
    n_xzw = ncas * 2 * ncas * 2 * (ncas * 2 - 1) // 2
    dim_act = n_x + n_xzw
    aa_ind = np.tril_indices(ncas * 2, k=-1)

    # Computing K11
    K11 = np.zeros((ncas * 2, ncas * 2))

    K11_a_a  = einsum('XY->XY', h_aa, optimize = einsum_type).copy()
    # K11_a_a -= 1/2 * einsum('Yx,xX->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a += einsum('XxYy,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('XxyY,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,yzXx->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    K11[::2,::2] = K11_a_a.copy()
    K11[1::2,1::2] = K11_a_a.copy()

    # Computing K12
    K12 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K12_a_bba =- 1/3 * einsum('Wx,YxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Wx,YxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,WZ->XZWY', h_aa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Yx,WxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('Yx,WxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('Zx,WYXx->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('Zx,WYxX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('WYxX,xZ->XZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WYxy,xyXZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WYxy,xyZX->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WxyX,YyZx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WxyX,YyxZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Wxyz,YyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Wxyz,YyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('XZxy,WYxy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('XZxy,WYyx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XxYy,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('XxyY,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('XxyY,WxyZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Yxyz,WyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WYxXyz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxXzy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/4 * einsum('Zxyz,WYxyXz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxyzX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzXy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzyX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('Wx,XY,xZ->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('Zx,XY,Wx->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,Wxyz,yzZx->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('XY,Zxyz,Wxyz->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K12[::2,1::2,1::2,::2] = K12_a_bba.copy()
    K12[1::2,::2,::2,1::2] = K12[::2,1::2,1::2,::2].copy()

    K12[::2,1::2,::2,1::2] -= K12_a_bba.transpose(0,1,3,2).copy()
    K12[1::2,::2,1::2,::2]  = K12[::2,1::2,::2,1::2].copy()

    K12[::2,::2,::2,::2]  = K12_a_bba.copy()
    K12[::2,::2,::2,::2] += K12[::2,1::2,::2,1::2].copy()
    K12[1::2,1::2,1::2,1::2] = K12[::2,::2,::2,::2].copy()

    # Computing K22
    K22 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K22_aab_aab =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,UYxVXZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxyW,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 3/10 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 2/15 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 11/40 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/15 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Wxyz,UYyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Wxyz,UYyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XxYy,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxyY,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 9/40 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/5 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/120 * einsum('Yxyz,UWyzZXVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzZXxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UWyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/10 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 2/15 * einsum('Zxyz,UWYxXVyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 11/40 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxyXVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Zxyz,UWYxzXVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxzXyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UWYxzyXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22_baa_baa =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,UWXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,UWZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,UYVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,UYZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,UYxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VXYW,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXYx,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXYx,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXxW,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXxW,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYW,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VxYW,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYy,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxyW,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WYXx,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WYXx,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxXy,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/40 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 2/15 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/10 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Wxyz,UYyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Wxyz,UYyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxyY,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 11/40 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 2/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/10 * einsum('Yxyz,UWyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UWyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/120 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/120 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UWYxyVXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WX,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Wx,VY,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Wx,VY,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,WX,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Yx,WX,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,VY,UWXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,VY,UWxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,WX,UYVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,WX,UYxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WxXy,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,WxyX,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,WxyX,UyxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Wxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VY,Wxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VY,XZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VY,XZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Zxyz,UWxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VY,Zxyz,UWxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WX,VZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WX,VZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,VxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,VxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Yxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('WX,Yxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Zxyz,UYxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('WX,Zxyz,UYxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zx,VY,WX,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zxyz,VY,WX,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    # decoupled # K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    # decoupled # K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    K22[::2,1::2,::2,::2,1::2,::2] = K22_aab_aab.transpose(0,2,1,3,5,4).copy()
    K22[1::2,::2,1::2,1::2,::2,1::2] = K22[::2,1::2,::2,::2,1::2,::2].copy()

    K22[::2,1::2,::2,::2,::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    K22[1::2,::2,1::2,1::2,1::2,::2] = K22[::2,1::2,::2,::2,::2,1::2].copy()

    K22[::2,::2,1::2,::2,1::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,::2,1::2,::2,1::2] = K22[::2,::2,1::2,::2,1::2,::2].copy()

    K22[::2,::2,::2,1::2,1::2,::2]  = K22_aab_aab.copy()
    K22[::2,::2,::2,1::2,1::2,::2] -= K22_baa_baa.copy()
    K22[::2,::2,::2,1::2,1::2,::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    K22[1::2,1::2,1::2,::2,::2,1::2] = K22[::2,::2,::2,1::2,1::2,::2].copy()

    K22[1::2,1::2,::2,::2,::2,::2]  = K22_aab_aab.copy()
    K22[1::2,1::2,::2,::2,::2,::2] -= K22_baa_baa.copy()
    K22[1::2,1::2,::2,::2,::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    K22[::2,::2,1::2,1::2,1::2,1::2] = K22[1::2,1::2,::2,::2,::2,::2].copy()

    K22[1::2,::2,1::2,::2,::2,::2] -= K22[1::2,1::2,::2,::2,::2,::2].transpose(0,2,1,3,4,5).copy()
    K22[::2,1::2,::2,1::2,1::2,1::2] = K22[1::2,::2,1::2,::2,::2,::2].copy()

    K22[::2,::2,::2,1::2,::2,1::2] -= K22[::2,::2,::2,1::2,1::2,::2].transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,1::2,::2,1::2,::2] = K22[::2,::2,::2,1::2,::2,1::2].copy()

    K22[::2,::2,::2,::2,::2,::2]  = K22[::2,::2,::2,1::2,1::2,::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,1::2,::2,1::2,::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,::2,1::2,1::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,1::2,1::2,1::2] = K22[::2,::2,::2,::2,::2,::2].copy()

    K12 = K12[:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,:,:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,aa_ind[0],aa_ind[1]]

    K_p1p = np.zeros((dim_act, dim_act))

    K_p1p[:n_x,:n_x] = K11.copy()
    K_p1p[:n_x,n_x:] = K12.reshape(n_x, n_xzw).copy()
    K_p1p[n_x:,:n_x] = K12.reshape(n_x, n_xzw).T.copy()
    K_p1p[n_x:,n_x:] = K22.reshape(n_xzw, n_xzw).copy()

    return K_p1p


def compute_K_caca(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    K_caca_dim = ncas * ncas
    K_caca = np.zeros((K_caca_dim * 2, K_caca_dim * 2))

    K_caca_aa_aa  = 1/2 * einsum('WY,XZ->XYZW', h_aa, rdm_ca, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Wx,XxYZ->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Wx,XxZY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Zx,WXYx->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Zx,WXxY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/2 * einsum('WxYy,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('WxyY,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('WxyY,XyxZ->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Wxyz,XyzYZx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Wxyz,XyzZYx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('YZxy,WXxy->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('YZxy,WXyx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Zxyz,WXxYyz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Zxyz,WXxyYz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/2 * einsum('Zx,WY,Xx->XYZW', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_caca_aa_aa -= 1/2 * einsum('WY,Zxyz,Xxyz->XYZW', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa = K_caca_aa_aa.reshape(K_caca_dim, K_caca_dim)

    K_caca_aa_bb  = 1/3 * einsum('Wx,XxYZ->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('Wx,XxZY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('Zx,WXYx->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('Zx,WXxY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('WxyY,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/3 * einsum('WxyY,XyxZ->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/4 * einsum('Wxyz,XyzYZx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzYxZ->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Wxyz,XyzZYx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzZxY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxYZ->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxZY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('YZxy,WXxy->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('YZxy,WXyx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Zxyz,WXxYyz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxYzy->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/4 * einsum('Zxyz,WXxyYz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxyzY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzYy->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzyY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb = K_caca_aa_bb.reshape(K_caca_dim, K_caca_dim)

    K_caca[:K_caca_dim,:K_caca_dim] = K_caca_aa_aa
    K_caca[K_caca_dim:,K_caca_dim:] = K_caca_aa_aa

    K_caca[:K_caca_dim,K_caca_dim:] = K_caca_aa_bb
    K_caca[K_caca_dim:,:K_caca_dim] = K_caca_aa_bb.T

    return K_caca

