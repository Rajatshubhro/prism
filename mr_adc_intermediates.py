import numpy as np

def compute_K_ac(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    # Compute K_ac: < Psi_0 | a_X [H_{act}, a^{\dag}_Y] | Psi_0 >
    K_ac  = einsum('XY->XY', h_aa, optimize = einsum_type).copy()
    K_ac += einsum('XxYy,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K_ac -= 1/2 * einsum('XxyY,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K_ac -= 1/2 * einsum('Yxyz,yzXx->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    return K_ac

def compute_K_ca(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa

    # Compute K_ca: < Psi_0 | a^{\dag}_X [H_{act}, a_Y] | Psi_0 >
    K_ca =- 1/2 * einsum('Yx,Xx->XY', h_aa, rdm_ca, optimize = einsum_type)
    K_ca -= 1/2 * einsum('Yxyz,Xxyz->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    return K_ca

def compute_K_aacc(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    # Compute K_aacc: < Psi_0 | a_Z a_W [H_{act}, a^{\dag}_X a^{\dag}_Y] | Psi_0 >
    K_aacc  = einsum('WZXY->ZWYX', v_aaaa, optimize = einsum_type).copy()
    K_aacc += einsum('WX,YZ->ZWYX', h_aa, np.identity(ncas), optimize = einsum_type)
    K_aacc += einsum('YZ,WX->ZWYX', h_aa, np.identity(ncas), optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,YZ->ZWYX', h_aa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/6 * einsum('Xx,YxWZ->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('Xx,YxZW->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,XW->ZWYX', h_aa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/3 * einsum('Yx,XxWZ->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('Yx,XxZW->ZWYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WZXx,Yx->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WZxY,Xx->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WxXY,xZ->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WxXy,YxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('WxyX,YxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('WxyX,YxyZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('WxyY,XxZy->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('WxyY,XxyZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('XYxZ,xW->ZWYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc += 1/3 * einsum('XYxy,xyWZ->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('XYxy,xyZW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('XxyZ,YyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('XxyZ,YyxW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/12 * einsum('Xxyz,YyzWZx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzWxZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc += 1/4 * einsum('Xxyz,YyzZWx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzZxW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzxWZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Xxyz,YyzxZW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YxZy,XyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/3 * einsum('YxyZ,XyWx->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/6 * einsum('YxyZ,XyxW->ZWYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += 1/4 * einsum('Yxyz,XyzWZx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzWxZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc += 1/12 * einsum('Yxyz,XyzZWx->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzZxW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzxWZ->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/12 * einsum('Yxyz,XyzxZW->ZWYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('Xx,YZ,xW->ZWYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('Yx,WX,xZ->ZWYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_aacc += einsum('WX,YxZy,yx->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,YxyZ,yx->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('WX,Yxyz,yzZx->ZWYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc += einsum('YZ,WxXy,xy->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,WxyX,xy->ZWYX', np.identity(ncas), v_aaaa, rdm_ca, optimize = einsum_type)
    K_aacc -= 1/2 * einsum('YZ,Xxyz,yzWx->ZWYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_aacc = K_aacc.reshape(ncas**2, ncas**2)

    return K_aacc

def compute_K_ccaa(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    # Compute K_ccaa: < Psi_0 | a^{\dag}_X a^{\dag}_Y [H_{act}, a_Z a_W] | Psi_0 >
    K_ccaa =- 1/6 * einsum('Wx,XYZx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('Wx,XYxZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('Zx,XYWx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/6 * einsum('Zx,XYxW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/3 * einsum('WZxy,XYxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/6 * einsum('WZxy,XYyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_ccaa -= 1/12 * einsum('Wxyz,XYxZyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxZzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/4 * einsum('Wxyz,XYxyZz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxyzZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxzZy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Wxyz,XYxzyZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/4 * einsum('Zxyz,XYxWyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxWzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa -= 1/12 * einsum('Zxyz,XYxyWz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxyzW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxzWy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa += 1/12 * einsum('Zxyz,XYxzyW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_ccaa = K_ccaa.reshape(ncas**2, ncas**2)

    return K_ccaa

def compute_K_caca(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    # Compute K_caca: < Psi_0 | a^{\dag}_X a_Y [H_{act}, a^{\dag}_W a_Z] | Psi_0 >
    K_caca_aa_aa  = 1/2 * einsum('WY,XZ->XYZW', h_aa, rdm_ca, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Wx,XxYZ->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Wx,XxZY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Zx,WXYx->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Zx,WXxY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/2 * einsum('WxYy,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('WxyY,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('WxyY,XyxZ->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Wxyz,XyzYZx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Wxyz,XyzZYx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('YZxy,WXxy->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('YZxy,WXyx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_aa += 1/6 * einsum('Zxyz,WXxYyz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/6 * einsum('Zxyz,WXxyYz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_aa -= 1/2 * einsum('Zx,WY,Xx->XYZW', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_caca_aa_aa -= 1/2 * einsum('WY,Zxyz,Xxyz->XYZW', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K_caca_aa_bb  = 1/3 * einsum('Wx,XxYZ->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('Wx,XxZY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('Zx,WXYx->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('Zx,WXxY->XYZW', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('WxyY,XyZx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/3 * einsum('WxyY,XyxZ->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/4 * einsum('Wxyz,XyzYZx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzYxZ->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Wxyz,XyzZYx->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzZxY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxYZ->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxZY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('YZxy,WXxy->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('YZxy,WXyx->XYZW', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Zxyz,WXxYyz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxYzy->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/4 * einsum('Zxyz,WXxyYz->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxyzY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzYy->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzyY->XYZW', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    ## Reshape tensors to matrix form
    dim_ZW = ncas * ncas
    dim_K = 2 * dim_ZW

    K_caca = np.zeros((dim_K, dim_K))

    # Building K_caca matrix
    K_aa_i = 0
    K_aa_f = K_aa_i + dim_ZW
    K_bb_i = K_aa_f
    K_bb_f = K_bb_i + dim_ZW

    K_caca_aa_aa = K_caca_aa_aa.reshape(dim_ZW, dim_ZW)
    K_caca_aa_bb = K_caca_aa_bb.reshape(dim_ZW, dim_ZW)

    K_caca[K_aa_i:K_aa_f, K_aa_i:K_aa_f] = K_caca_aa_aa
    K_caca[K_bb_i:K_bb_f, K_bb_i:K_bb_f] = K_caca_aa_aa

    K_caca[K_aa_i:K_aa_f, K_bb_i:K_bb_f] = K_caca_aa_bb
    K_caca[K_bb_i:K_bb_f, K_aa_i:K_aa_f] = K_caca_aa_bb

    return K_caca

def compute_K_p1p(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    # Computing K11
    # K11 block: < Psi_0 | a_X [H_{act}, a^{\dag}_Z] | Psi_0>
    K11_a_a  = einsum('XZ->XZ', h_aa, optimize = einsum_type).copy()
    K11_a_a += einsum('XxZy,xy->XZ', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('XxyZ,xy->XZ', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Zxyz,yzXx->XZ', v_aaaa, rdm_ccaa, optimize = einsum_type)

    # K12 block: < Psi_0 | a_X [H_{act}, a^{\dag}_Z a^{\dag}_W a_Y] | Psi_0>
    K12_a_bba =- 1/3 * einsum('Wx,XYZx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Wx,XYxZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XZ,WY->XYWZ', h_aa, rdm_ca, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('Yx,WZXx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('Yx,WZxX->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Zx,WxXY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('Zx,WxYX->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('WZxX,xY->XYWZ', v_aaaa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WZxy,XYxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WZxy,XYyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WxyX,YxZy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WxyX,YxyZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Wxyz,ZyzXYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,ZyzXxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Wxyz,ZyzYXx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,ZyzYxX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,ZyzxXY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,ZyzxYX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('XYxy,WZxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('XYxy,WZyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XxZy,WxYy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('XxyZ,WxYy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('XxyZ,WxyY->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WZxXyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WZxXzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/4 * einsum('Yxyz,WZxyXz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WZxyzX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WZxzXy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WZxzyX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WyzXYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WyzXxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Zxyz,WyzYXx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WyzYxX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WyzxXY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WyzxYX->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('Wx,XZ,xY->XYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('Yx,XZ,Wx->XYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XZ,Wxyz,Yxyz->XYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('XZ,Yxyz,Wxyz->XYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K12_a_aaa = np.ascontiguousarray(K12_a_bba - K12_a_bba.transpose(0,1,3,2))

    # K22 block: < Psi_0 | a^{\dag}_U a_V a_X [H_{act}, a^{\dag}_Z a^{\dag}_W a_Y] | Psi_0>
    K22_aaa_aaa =- 1/6 * einsum('VX,UYWZ->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VX,UYZW->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VY,UXWZ->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VY,UXZW->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WX,UYVZ->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WX,UYZV->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WY,UXVZ->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WY,UXZV->UVWZYX', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Xx,UYxVZW->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Xx,UYxWVZ->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Xx,UYxZWV->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Yx,UXxVZW->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Yx,UXxWVZ->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Yx,UXxZWV->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Zx,UXYVxW->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Zx,UXYWVx->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Zx,UXYxWV->UVWZYX', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('VWXY,UZ->UVWZYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VWXx,UYZx->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VWXx,UYxZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('VWYX,UZ->UVWZYX', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VWYx,UXZx->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VWYx,UXxZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VWxX,UYZx->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VWxX,UYxZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VWxY,UXZx->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VWxY,UXxZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VZxy,UXYWxy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VZxy,UXYWyx->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VZxy,UXYxWy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VZxy,UXYxyW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VZxy,UXYyWx->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VZxy,UXYyxW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VxXY,UxWZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VxXY,UxZW->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VxXy,UYxWZy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VxXy,UYxZWy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VxYX,UxWZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VxYX,UxZW->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VxYy,UXxWZy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VxYy,UXxZWy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('VxyX,UYxWyZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('VxyX,UYxZWy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('VxyX,UYxyZW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyY,UXxWyZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyY,UXxZWy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyY,UXxyZW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WZxy,UXYVxy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WZxy,UXYVyx->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WZxy,UXYxVy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WZxy,UXYxyV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WZxy,UXYyVx->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WZxy,UXYyxV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WxXY,UxVZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WxXY,UxZV->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WxXy,UYxVZy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WxXy,UYxZVy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WxYX,UxVZ->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WxYX,UxZV->UVWZYX', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WxYy,UXxVZy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WxYy,UXxZVy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('WxyX,UYxVyZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('WxyX,UYxZVy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('WxyX,UYxyZV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('WxyY,UXxVyZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('WxyY,UXxZVy->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('WxyY,UXxyZV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('XYxy,UxyVWZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('XYxy,UxyVZW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('XYxy,UxyWVZ->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('XYxy,UxyWZV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('XYxy,UxyZVW->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('XYxy,UxyZWV->UVWZYX', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Xxyz,UYyzVxWZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Xxyz,UYyzVxZW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Xxyz,UYyzWVZx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Xxyz,UYyzWVxZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Xxyz,UYyzWxVZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Xxyz,UYyzWxZV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Xxyz,UYyzZVWx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Xxyz,UYyzZVxW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Xxyz,UYyzZWVx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Xxyz,UYyzZWxV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Xxyz,UYyzZxVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Xxyz,UYyzZxWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Xxyz,UYyzxVWZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Xxyz,UYyzxVZW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Xxyz,UYyzxWVZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Xxyz,UYyzxWZV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Xxyz,UYyzxZVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Xxyz,UYyzxZWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Yxyz,UXyzVxWZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Yxyz,UXyzVxZW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXyzWVZx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXyzWVxZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXyzWxVZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXyzWxZV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXyzZVWx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXyzZVxW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXyzZWVx->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXyzZWxV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXyzZxVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXyzZxWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXyzxVWZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXyzxVZW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXyzxWVZ->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXyzxWZV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Yxyz,UXyzxZVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Yxyz,UXyzxZWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Zxyz,UXYxVyWz->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Zxyz,UXYxVzWy->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXYxWVyz->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXYxWVzy->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXYxWyVz->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXYxWyzV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXYxWzVy->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXYxWzyV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXYxyVWz->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXYxyWVz->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXYxyWzV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Zxyz,UXYxyzVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXYxyzWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXYxzVWy->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXYxzWVy->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXYxzWyV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Zxyz,UXYxzyVW->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXYxzyWV->UVWZYX', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('VX,WY,UZ->UVWZYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('VY,WX,UZ->UVWZYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('WX,VY,UZ->UVWZYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('WY,VX,UZ->UVWZYX', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Xx,VY,UxWZ->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Xx,VY,UxZW->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Xx,WY,UxVZ->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Xx,WY,UxZV->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Yx,VX,UxWZ->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Yx,VX,UxZW->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Yx,WX,UxVZ->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Yx,WX,UxZV->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Zx,VX,UYWx->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Zx,VX,UYxW->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Zx,VY,UXWx->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Zx,VY,UXxW->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Zx,WX,UYVx->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Zx,WX,UYxV->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Zx,WY,UXVx->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Zx,WY,UXxV->UVWZYX', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VX,WZxy,UYxy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VX,WZxy,UYyx->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('VX,WxYy,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VX,WxyY,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VX,WxyY,UxyZ->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VX,Yxyz,UyzWZx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VX,Yxyz,UyzZWx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VX,Zxyz,UYxWyz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VX,Zxyz,UYxyWz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VY,WZxy,UXxy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VY,WZxy,UXyx->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('VY,WxXy,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VY,WxyX,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VY,WxyX,UxyZ->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VY,Xxyz,UyzWZx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VY,Xxyz,UyzZWx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VY,Zxyz,UXxWyz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VY,Zxyz,UXxyWz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WX,VZxy,UYxy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WX,VZxy,UYyx->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('WX,VxYy,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WX,VxyY,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WX,VxyY,UxyZ->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WX,Yxyz,UyzVZx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WX,Yxyz,UyzZVx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WX,Zxyz,UYxVyz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WX,Zxyz,UYxyVz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WY,VZxy,UXxy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WY,VZxy,UXyx->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('WY,VxXy,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WY,VxyX,UxZy->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WY,VxyX,UxyZ->UVWZYX', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WY,Xxyz,UyzVZx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WY,Xxyz,UyzZVx->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('WY,Zxyz,UXxVyz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('WY,Zxyz,UXxyVz->UVWZYX', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('Zx,VX,WY,Ux->UVWZYX', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('Zx,VY,WX,Ux->UVWZYX', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aaa_aaa += 1/2 * einsum('Zxyz,VX,WY,Uxyz->UVWZYX', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/2 * einsum('Zxyz,VY,WX,Uxyz->UVWZYX', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22_bba_bba =- 1/6 * einsum('VW,UZXY->UVXYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/3 * einsum('VW,UZYX->UVXYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Wx,UZxVXY->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Wx,UZxVYX->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Wx,UZxXVY->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('Wx,UZxYXV->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XZ,UWVY->UVXYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XZ,UWYV->UVXYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('Yx,UWZVxX->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Yx,UWZXVx->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Yx,UWZxVX->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Yx,UWZxXV->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Zx,UWxVYX->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('Zx,UWxXVY->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('Zx,UWxYVX->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('Zx,UWxYXV->UVXYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/2 * einsum('VXWZ,UY->UVXYWZ', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_bba_bba -= 1/3 * einsum('VXWx,UZYx->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VXWx,UZxY->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VXxZ,UWYx->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VXxZ,UWxY->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('VYxy,UWZXxy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('VYxy,UWZXyx->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('VYxy,UWZxXy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/8 * einsum('VYxy,UWZxyX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('VYxy,UWZyXx->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/8 * einsum('VYxy,UWZyxX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VxWZ,UxXY->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/3 * einsum('VxWZ,UxYX->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VxWy,UZxXyY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VxWy,UZxYXy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VxWy,UZxYyX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VxWy,UZxyXY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VxWy,UZxyYX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VxyW,UZxXyY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VxyW,UZxYXy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VxyW,UZxyXY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VxyW,UZxyYX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VxyZ,UWxXyY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VxyZ,UWxYXy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VxyZ,UWxYyX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VxyZ,UWxyYX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('WZxX,UxVY->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('WZxX,UxYV->UVXYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('WZxy,UxyVXY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/8 * einsum('WZxy,UxyVYX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('WZxy,UxyXVY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('WZxy,UxyXYV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/8 * einsum('WZxy,UxyYVX->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('WZxy,UxyYXV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('WxyX,UZyVxY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('WxyX,UZyYVx->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('WxyX,UZyYxV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('WxyX,UZyxYV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/30 * einsum('Wxyz,VXYxUyZz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Wxyz,VXYxUyzZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Wxyz,VXYxUzZy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/60 * einsum('Wxyz,VXYxUzyZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/40 * einsum('Wxyz,VXYxZUyz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 7/120 * einsum('Wxyz,VXYxZUzy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/20 * einsum('Wxyz,VXYxZyUz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/15 * einsum('Wxyz,VXYxZyzU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/20 * einsum('Wxyz,VXYxZzUy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/8 * einsum('Wxyz,VXYxyUZz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/40 * einsum('Wxyz,VXYxyUzZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/10 * einsum('Wxyz,VXYxyZUz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Wxyz,VXYxyzUZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Wxyz,VXYxyzZU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('Wxyz,VXYxzUZy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/40 * einsum('Wxyz,VXYxzUyZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/20 * einsum('Wxyz,VXYxzZUy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 7/30 * einsum('Wxyz,VXYxzyUZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/20 * einsum('Wxyz,VXYxzyZU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('XYxy,UWZVxy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/8 * einsum('XYxy,UWZVyx->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('XYxy,UWZxVy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('XYxy,UWZxyV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/8 * einsum('XYxy,UWZyVx->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('XYxy,UWZyxV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XxZy,UWxVYy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XxZy,UWxYVy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XxyZ,UWxVYy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('XxyZ,UWxVyY->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('XxyZ,UWxYVy->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('XxyZ,UWxyYV->UVXYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Yxyz,VXyzUWZx->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('Yxyz,VXyzUWxZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/30 * einsum('Yxyz,VXyzUxWZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/60 * einsum('Yxyz,VXyzUxZW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/20 * einsum('Yxyz,VXyzWUZx->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/10 * einsum('Yxyz,VXyzWUxZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 13/60 * einsum('Yxyz,VXyzWxUZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/60 * einsum('Yxyz,VXyzWxZU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/40 * einsum('Yxyz,VXyzZUWx->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 7/120 * einsum('Yxyz,VXyzZUxW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/8 * einsum('Yxyz,VXyzZWUx->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/24 * einsum('Yxyz,VXyzZWxU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 7/40 * einsum('Yxyz,VXyzZxUW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/40 * einsum('Yxyz,VXyzZxWU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Yxyz,VXyzxUZW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 7/30 * einsum('Yxyz,VXyzxWUZ->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 3/20 * einsum('Yxyz,VXyzxZUW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/10 * einsum('Yxyz,VXyzxZWU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/20 * einsum('Zxyz,VXYxUWyz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/60 * einsum('Zxyz,VXYxUWzy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/40 * einsum('Zxyz,VXYxUyzW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/24 * einsum('Zxyz,VXYxUzyW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 3/40 * einsum('Zxyz,VXYxWUyz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/40 * einsum('Zxyz,VXYxWUzy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/10 * einsum('Zxyz,VXYxWyUz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/20 * einsum('Zxyz,VXYxWzUy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/60 * einsum('Zxyz,VXYxWzyU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/40 * einsum('Zxyz,VXYxyUWz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('Zxyz,VXYxyUzW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Zxyz,VXYxyWUz->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 19/120 * einsum('Zxyz,VXYxyzUW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/60 * einsum('Zxyz,VXYxyzWU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 3/40 * einsum('Zxyz,VXYxzUWy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 7/60 * einsum('Zxyz,VXYxzUyW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Zxyz,VXYxzWUy->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 1/30 * einsum('Zxyz,VXYxzWyU->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba -= 7/40 * einsum('Zxyz,VXYxzyUW->UVXYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_bba_bba += 1/2 * einsum('VW,XZ,UY->UVXYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('Wx,XZ,UxVY->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Wx,XZ,UxYV->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/2 * einsum('XZ,VW,UY->UVXYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('Yx,VW,UZXx->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/3 * einsum('Yx,VW,UZxX->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Yx,XZ,UWVx->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('Yx,XZ,UWxV->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('Zx,VW,UxXY->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/3 * einsum('Zx,VW,UxYX->UVXYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('VW,XYxy,UZxy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/3 * einsum('VW,XYxy,UZyx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/2 * einsum('VW,XxZy,UxYy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/3 * einsum('VW,XxyZ,UxYy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('VW,XxyZ,UxyY->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VW,Yxyz,UZxXyz->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VW,Yxyz,UZxXzy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/4 * einsum('VW,Yxyz,UZxyXz->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VW,Yxyz,UZxyzX->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VW,Yxyz,UZxzXy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VW,Yxyz,UZxzyX->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/12 * einsum('VW,Zxyz,UyzXYx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VW,Zxyz,UyzXxY->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/4 * einsum('VW,Zxyz,UyzYXx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VW,Zxyz,UyzYxX->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VW,Zxyz,UyzxXY->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/12 * einsum('VW,Zxyz,UyzxYX->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XZ,VYxy,UWxy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XZ,VYxy,UWyx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/2 * einsum('XZ,VxWy,UxYy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XZ,VxyW,UxYy->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XZ,VxyW,UxyY->UVXYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XZ,Wxyz,UyzVYx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XZ,Wxyz,UyzYVx->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/6 * einsum('XZ,Yxyz,UWxVyz->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba += 1/6 * einsum('XZ,Yxyz,UWxyVz->UVXYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_bba_bba -= 1/2 * einsum('Yx,VW,XZ,Ux->UVXYWZ', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_bba_bba -= 1/2 * einsum('Yxyz,VW,XZ,Uxyz->UVXYWZ', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22_aaa_bba = np.ascontiguousarray(K22_aaa_aaa - K22_bba_bba.transpose(0,2,1,3,5,4) + K22_bba_bba.transpose(0,1,2,3,5,4))
    K22_bba_aaa = np.ascontiguousarray(K22_aaa_aaa - K22_bba_bba.transpose(0,2,1,3,5,4) + K22_bba_bba.transpose(0,2,1,3,4,5))

    # Reshape tensors to matrix form
    dim_X = ncas
    dim_YWZ = ncas * ncas * ncas
    dim_tril_YWZ = ncas * ncas * (ncas - 1) // 2

    dim_act = dim_X + dim_tril_YWZ + dim_YWZ

    tril_ind = np.tril_indices(ncas, k=-1)

    K12_a_aaa = K12_a_aaa[:,:,tril_ind[0],tril_ind[1]]

    K22_aaa_aaa = K22_aaa_aaa[:,:,:,:,tril_ind[0],tril_ind[1]]
    K22_aaa_aaa = K22_aaa_aaa[:,tril_ind[0],tril_ind[1]]

    K22_aaa_bba = K22_aaa_bba[:,tril_ind[0],tril_ind[1]]
    K22_bba_aaa = K22_bba_aaa[:,:,:,:,tril_ind[0],tril_ind[1]]

    K12_a_aaa = K12_a_aaa.reshape(dim_X, dim_tril_YWZ)
    K12_a_bba = K12_a_bba.reshape(dim_X, dim_YWZ)

    K22_aaa_aaa = K22_aaa_aaa.reshape(dim_tril_YWZ, dim_tril_YWZ)
    K22_aaa_bba = K22_aaa_bba.reshape(dim_tril_YWZ, dim_YWZ)

    K22_bba_aaa = K22_bba_aaa.reshape(dim_YWZ, dim_tril_YWZ)
    K22_bba_bba = K22_bba_bba.reshape(dim_YWZ, dim_YWZ)

    # Build K_p1p matrix
    K_a_i = 0
    K_a_f = dim_X
    K_aaa_i = K_a_f
    K_aaa_f = K_aaa_i + dim_tril_YWZ
    K_bba_i = K_aaa_f
    K_bba_f = K_bba_i + dim_YWZ

    K_p1p = np.zeros((dim_act, dim_act))

    K_p1p[K_a_i:K_a_f, K_a_i:K_a_f] = K11_a_a

    K_p1p[K_a_i:K_a_f, K_aaa_i:K_aaa_f] = K12_a_aaa
    K_p1p[K_a_i:K_a_f, K_bba_i:K_bba_f] = K12_a_bba

    K_p1p[K_aaa_i:K_aaa_f, K_a_i:K_a_f] = K12_a_aaa.T
    K_p1p[K_bba_i:K_bba_f, K_a_i:K_a_f] = K12_a_bba.T

    K_p1p[K_aaa_i:K_aaa_f, K_aaa_i:K_aaa_f] = K22_aaa_aaa
    K_p1p[K_aaa_i:K_aaa_f, K_bba_i:K_bba_f] = K22_aaa_bba

    K_p1p[K_bba_i:K_bba_f, K_aaa_i:K_aaa_f] = K22_bba_aaa
    K_p1p[K_bba_i:K_bba_f, K_bba_i:K_bba_f] = K22_bba_bba

    return K_p1p

def compute_K_m1p(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    # Computing K11
    # K11 block: < Psi_0 | a^{\dag}_X [H_{act}, a_Y] | Psi_0>
    K11_a_a =- 1/2 * einsum('Yx,Xx->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,Xxyz->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    # K12 block: < Psi_0 | a^{\dag}_X [H_{act}, a^{\dag}_Z a_W a_Y] | Psi_0>
    K12_a_abb =- 1/3 * einsum('Wx,XZYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Wx,XZxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Yx,XZWx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('Yx,XZxW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/6 * einsum('Zx,XxWY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/3 * einsum('Zx,XxYW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('WYxy,XZxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('WYxy,XZyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Wxyz,XZxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Wxyz,XZxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Yxyz,XZxWyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxWzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Yxyz,XZxyWz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxyzW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzWy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzyW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Zxyz,XyzWYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzWxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/4 * einsum('Zxyz,XyzYWx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzYxW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxWY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxYW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K12_a_aaa = np.ascontiguousarray(K12_a_abb - K12_a_abb.transpose(0,2,1,3))

    # K22 block: < Psi_0 | a^{\dag}_X a^{\dag}_U a_V [H_{act}, a^{\dag}_Z a_W a_Y] | Psi_0>
    K22_aaa_aaa  = 1/6 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/24 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Wxyz,UXZxyYVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Wxyz,UXZxyYzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Wxyz,UXZxyzVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Wxyz,UXZxyzYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXZxWyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXZxWyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXZxWzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXZxWzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXZxyWVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Yxyz,UXZxyzVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXZxyzWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Yxyz,UXZxzyWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXyzWxVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXyzWxYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/60 * einsum('Zxyz,UXyzYWVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/60 * einsum('Zxyz,UXyzYWxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXyzYxVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/120 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/120 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/40 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/40 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa -= 1/6 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aaa_aaa += 1/6 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22_abb_abb  = 1/3 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_abb_abb += 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('Wx,UXZVYx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/6 * einsum('Yx,UXZWxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('Zx,UXxWYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/8 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/8 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/8 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/8 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/3 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('VxyZ,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/8 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/8 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 3/10 * einsum('Wxyz,UXZxVYyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/10 * einsum('Wxyz,UXZxVYzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 3/20 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/30 * einsum('Wxyz,UXZxVyzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/10 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/30 * einsum('Wxyz,UXZxVzyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 11/40 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 2/15 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/20 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/30 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 7/60 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 3/40 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/40 * einsum('Wxyz,UXZxyVzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Wxyz,UXZxyzVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 7/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 3/40 * einsum('Wxyz,UXZxzVyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/20 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/10 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/60 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/30 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/6 * einsum('Yxyz,UXZxVWzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/10 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 7/40 * einsum('Yxyz,UXZxVyzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 3/20 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 7/40 * einsum('Yxyz,UXZxVzyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/120 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 3/40 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 11/120 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/10 * einsum('Yxyz,UXZxyVzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/15 * einsum('Yxyz,UXZxyWVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/40 * einsum('Yxyz,UXZxyzVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 3/40 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/10 * einsum('Yxyz,UXZxzVyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/40 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 2/15 * einsum('Zxyz,UXyzVWYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/30 * einsum('Zxyz,UXyzVWxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 3/10 * einsum('Zxyz,UXyzVYWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/10 * einsum('Zxyz,UXyzVYxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/20 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/10 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/15 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/60 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 11/40 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/24 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/8 * einsum('Zxyz,UXyzYWVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/24 * einsum('Zxyz,UXyzYWxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/40 * einsum('Zxyz,UXyzYxVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/8 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/15 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/60 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/20 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb += 1/10 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/3 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/3 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/3 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Wxyz,UXxYzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/4 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Wxyz,UXxyzY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Wxyz,UXxzYy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Wxyz,UXxzyY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/4 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Yxyz,UXxWzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb -= 1/12 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Yxyz,UXxyzW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Yxyz,UXxzWy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_abb_abb += 1/12 * einsum('VZ,Yxyz,UXxzyW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22_aaa_abb = np.ascontiguousarray(K22_aaa_aaa - K22_abb_abb.transpose(1,0,2,4,3,5) + K22_abb_abb.transpose(0,1,2,4,3,5))
    K22_abb_aaa = np.ascontiguousarray(K22_aaa_aaa - K22_abb_abb.transpose(1,0,2,4,3,5) + K22_abb_abb.transpose(1,0,2,3,4,5))

    # Reshape tensors to matrix form
    dim_X = ncas
    dim_YWZ = ncas * ncas * ncas
    dim_tril_YWZ = ncas * ncas * (ncas - 1) // 2

    dim_act = dim_X + dim_tril_YWZ + dim_YWZ

    tril_ind = np.tril_indices(ncas, k=-1)

    K12_a_aaa = K12_a_aaa[:,tril_ind[0],tril_ind[1]]

    K22_aaa_aaa = K22_aaa_aaa[:,:,:,tril_ind[0],tril_ind[1]]
    K22_aaa_aaa = K22_aaa_aaa[tril_ind[0],tril_ind[1]]

    K22_aaa_abb = K22_aaa_abb[tril_ind[0],tril_ind[1]]
    K22_abb_aaa = K22_abb_aaa[:,:,:,tril_ind[0],tril_ind[1]]

    K12_a_aaa = K12_a_aaa.reshape(dim_X, dim_tril_YWZ)
    K12_a_abb = K12_a_abb.reshape(dim_X, dim_YWZ)

    K22_aaa_aaa = K22_aaa_aaa.reshape(dim_tril_YWZ, dim_tril_YWZ)
    K22_aaa_abb = K22_aaa_abb.reshape(dim_tril_YWZ, dim_YWZ)

    K22_abb_aaa = K22_abb_aaa.reshape(dim_YWZ, dim_tril_YWZ)
    K22_abb_abb = K22_abb_abb.reshape(dim_YWZ, dim_YWZ)

    # Build K_m1p matrix
    K_a_i = 0
    K_a_f = dim_X
    K_aaa_i = K_a_f
    K_aaa_f = K_aaa_i + dim_tril_YWZ
    K_abb_i = K_aaa_f
    K_abb_f = K_abb_i + dim_YWZ

    K_m1p = np.zeros((dim_act, dim_act))

    K_m1p[K_a_i:K_a_f, K_a_i:K_a_f] = K11_a_a

    K_m1p[K_a_i:K_a_f, K_aaa_i:K_aaa_f] = K12_a_aaa
    K_m1p[K_a_i:K_a_f, K_abb_i:K_abb_f] = K12_a_abb

    K_m1p[K_aaa_i:K_aaa_f, K_a_i:K_a_f] = K12_a_aaa.T
    K_m1p[K_abb_i:K_abb_f, K_a_i:K_a_f] = K12_a_abb.T

    K_m1p[K_aaa_i:K_aaa_f, K_aaa_i:K_aaa_f] = K22_aaa_aaa
    K_m1p[K_aaa_i:K_aaa_f, K_abb_i:K_abb_f] = K22_aaa_abb

    K_m1p[K_abb_i:K_abb_f, K_aaa_i:K_aaa_f] = K22_abb_aaa
    K_m1p[K_abb_i:K_abb_f, K_abb_i:K_abb_f] = K22_abb_abb

    return K_m1p

# Spin-Orbital Sanity Check Functions
def compute_K_caca_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    K_caca = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K_caca_ab_ba  = 1/2 * einsum('WY,XZ->XYWZ', h_aa, rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/2 * einsum('WxYy,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/3 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/6 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/4 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/3 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/6 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_ab_ba += 1/4 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba += 1/12 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('Zx,WY,Xx->XYWZ', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K_caca_ab_ba -= 1/2 * einsum('WY,Zxyz,Xxyz->XYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K_caca_aa_bb  = 1/3 * einsum('Wx,XxYZ->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('Wx,XxZY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('Zx,WXYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('Zx,WXxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/6 * einsum('WxyY,XyZx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/3 * einsum('WxyY,XyxZ->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb += 1/4 * einsum('Wxyz,XyzYZx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzYxZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Wxyz,XyzZYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzZxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxYZ->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Wxyz,XyzxZY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/6 * einsum('YZxy,WXxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/3 * einsum('YZxy,WXyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/12 * einsum('Zxyz,WXxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb -= 1/4 * einsum('Zxyz,WXxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K_caca_aa_bb += 1/12 * einsum('Zxyz,WXxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K_caca[::2,1::2,1::2,::2] = K_caca_ab_ba.copy()
    K_caca[1::2,::2,::2,1::2] = K_caca_ab_ba.copy()

    K_caca[::2,::2,1::2,1::2] = K_caca_aa_bb.copy()
    K_caca[1::2,1::2,::2,::2] = K_caca_aa_bb.copy()

    K_caca[::2,::2,::2,::2]  = K_caca_ab_ba.copy()
    K_caca[::2,::2,::2,::2] += K_caca_aa_bb.copy()
    K_caca[1::2,1::2,1::2,1::2] = K_caca[::2,::2,::2,::2].copy()

    return K_caca

def compute_K_p1p_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    n_x = ncas * 2
    n_xzw = ncas * 2 * ncas * 2 * (ncas * 2 - 1) // 2
    dim_act = n_x + n_xzw
    aa_ind = np.tril_indices(ncas * 2, k=-1)

    # Computing K11
    K11 = np.zeros((ncas * 2, ncas * 2))

    K11_a_a  = einsum('XY->XY', h_aa, optimize = einsum_type).copy()
    # K11_a_a -= 1/2 * einsum('Yx,xX->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a += einsum('XxYy,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('XxyY,xy->XY', v_aaaa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,yzXx->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    K11[::2,::2] = K11_a_a.copy()
    K11[1::2,1::2] = K11_a_a.copy()

    # Computing K12
    K12 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K12_a_bba =- 1/3 * einsum('Wx,YxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Wx,YxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,WZ->XZWY', h_aa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('Yx,WxXZ->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('Yx,WxZX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('Zx,WYXx->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('Zx,WYxX->XZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('WYxX,xZ->XZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WYxy,xyXZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WYxy,xyZX->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('WxyX,YyZx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('WxyX,YyxZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Wxyz,YyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Wxyz,YyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Wxyz,YyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/6 * einsum('XZxy,WYxy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/3 * einsum('XZxy,WYyx->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XxYy,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/3 * einsum('XxyY,WxZy->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/6 * einsum('XxyY,WxyZ->XZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Yxyz,WyzXZx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzXxZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/4 * einsum('Yxyz,WyzZXx->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzZxX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxXZ->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Yxyz,WyzxZX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/12 * einsum('Zxyz,WYxXyz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxXzy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/4 * einsum('Zxyz,WYxyXz->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxyzX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzXy->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba -= 1/12 * einsum('Zxyz,WYxzyX->XZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('Wx,XY,xZ->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('Zx,XY,Wx->XZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K12_a_bba += 1/2 * einsum('XY,Wxyz,yzZx->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_bba -= 1/2 * einsum('XY,Zxyz,Wxyz->XZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)

    K12[::2,1::2,1::2,::2] = K12_a_bba.copy()
    K12[1::2,::2,::2,1::2] = K12[::2,1::2,1::2,::2].copy()

    K12[::2,1::2,::2,1::2] -= K12_a_bba.transpose(0,1,3,2).copy()
    K12[1::2,::2,1::2,::2]  = K12[::2,1::2,::2,1::2].copy()

    K12[::2,::2,::2,::2]  = K12_a_bba.copy()
    K12[::2,::2,::2,::2] += K12[::2,1::2,::2,1::2].copy()
    K12[1::2,1::2,1::2,1::2] = K12[::2,::2,::2,::2].copy()

    # Computing K22
    K22 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K22_aab_aab =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,UYxVXZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxyW,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 3/10 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 2/15 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 11/40 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/15 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Wxyz,UYyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Wxyz,UYyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XxYy,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XxyY,UWxVZy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 9/40 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/5 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/120 * einsum('Yxyz,UWyzZXVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzZXxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UWyzxXVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UWyzxXZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/10 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 2/15 * einsum('Zxyz,UWYxXVyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 11/40 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxyXVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Zxyz,UWYxzXVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Zxyz,UWYxzXyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UWYxzyXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_aab_aab -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22_baa_baa =- 1/6 * einsum('VW,UYXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,UYZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,UWXZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,UWZX->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,UYVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,UYZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UYxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,UYxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Wx,UYxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,UWVZ->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,UWZV->UVXZWY', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxVZX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UWxXVZ->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,UWxZVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Yx,UWxZXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYVxX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UWYXVx->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,UWYxVX->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zx,UWYxXV->UVXZWY', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VXWY,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXWx,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXWx,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VXYW,UZ->UVXZWY', v_aaaa, rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXYx,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXYx,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VXxW,UYZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VXxW,UYxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VXxY,UWZx->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VXxY,UWxZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYXxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYXyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VZxy,UWYxXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VZxy,UWYxyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VZxy,UWYyXx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VZxy,UWYyxX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWY,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VxWY,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxWy,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxWy,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYW,UxXZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VxYW,UxZX->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxYy,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxYy,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyW,UYxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxyW,UYxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyW,UYxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxXyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyY,UWxZXy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxyY,UWxZyX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyY,UWxyZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WYXx,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WYXx,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WYxX,UxVZ->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WYxX,UxZV->UVXZWY', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyVXZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyVZX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UxyXVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UxyXZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('WYxy,UxyZVX->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('WYxy,UxyZXV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxXy,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WxXy,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyVxZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WxyX,UYyZVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WxyX,UYyZxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WxyX,UYyxZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Wxyz,UYyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Wxyz,UYyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/40 * einsum('Wxyz,UYyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Wxyz,UYyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wxyz,UYyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Wxyz,UYyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 2/15 * einsum('Wxyz,UYyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UYyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Wxyz,UYyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UYyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/10 * einsum('Wxyz,UYyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Wxyz,UYyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Wxyz,UYyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Wxyz,UYyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UYyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Wxyz,UYyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('Wxyz,UYyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYVxy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYVyx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('XZxy,UWYxVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('XZxy,UWYxyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('XZxy,UWYyVx->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('XZxy,UWYyxV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxYy,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyVZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XxYy,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxVyZ->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XxyY,UWxZVy->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XxyY,UWxZyV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XxyY,UWxyZV->UVXZWY', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Yxyz,UWyzVXZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Yxyz,UWyzVXxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 11/40 * einsum('Yxyz,UWyzVZXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Yxyz,UWyzVZxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yxyz,UWyzVxXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Yxyz,UWyzVxZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 2/15 * einsum('Yxyz,UWyzXVZx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Yxyz,UWyzXVxZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzXZVx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Yxyz,UWyzXZxV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxVZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UWyzXxZV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/10 * einsum('Yxyz,UWyzZVXx->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzZVxX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Yxyz,UWyzZxVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UWyzZxXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Yxyz,UWyzxVXZ->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UWyzxVZX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/40 * einsum('Yxyz,UWyzxZVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Yxyz,UWyzxZXV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/120 * einsum('Zxyz,UWYxVXyz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVXzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/120 * einsum('Zxyz,UWYxVyXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVyzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Zxyz,UWYxVzXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UWYxVzyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zxyz,UWYxXVzy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Zxyz,UWYxXyVz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXyzV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzVy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UWYxXzyV->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UWYxyVXz->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxyVzX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxyzVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/20 * einsum('Zxyz,UWYxzVXy->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Zxyz,UWYxzVyX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Zxyz,UWYxzyVX->UVXZWY', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WX,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VY,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Wx,VY,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Wx,VY,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,XY,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Wx,XY,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VW,UZ->UVXZWY', h_aa, np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Yx,VW,UxXZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Yx,VW,UxZX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,WX,UxVZ->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Yx,WX,UxZV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,VW,UYXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,VW,UYxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,VY,UWXx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,VY,UWxX->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,WX,UYVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Zx,WX,UYxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Zx,XY,UWVx->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('Zx,XY,UWxV->UVXZWY', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VW,XZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VW,XZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('VW,XxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VW,XxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VW,XxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Yxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VW,Yxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Yxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VW,Zxyz,UYxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VW,Zxyz,UYxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VW,Zxyz,UYxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('VY,WxXy,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VY,WxyX,UyZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VY,WxyX,UyxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Wxyz,UyzXZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzXxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('VY,Wxyz,UyzZXx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzZxX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxXZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Wxyz,UyzxZX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VY,XZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VY,XZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VY,Zxyz,UWxXyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxXzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VY,Zxyz,UWxyXz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxyzX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzXy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VY,Zxyz,UWxzyX->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('WX,VZxy,UYxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('WX,VZxy,UYyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('WX,VxYy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('WX,VxyY,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('WX,VxyY,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Yxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('WX,Yxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Yxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('WX,Zxyz,UYxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('WX,Zxyz,UYxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('WX,Zxyz,UYxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('XY,VZxy,UWxy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('XY,VZxy,UWyx->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('XY,VxWy,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('XY,VxyW,UxZy->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('XY,VxyW,UxyZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Wxyz,UyzVZx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzVxZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('XY,Wxyz,UyzZVx->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzZxV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxVZ->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Wxyz,UyzxZV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('XY,Zxyz,UWxVyz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxVzy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/4 * einsum('XY,Zxyz,UWxyVz->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxyzV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzVy->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('XY,Zxyz,UWxzyV->UVXZWY', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zx,VW,XY,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zx,VY,WX,Ux->UVXZWY', h_aa, np.identity(ncas), np.identity(ncas), rdm_ca, optimize = einsum_type)
    K22_baa_baa -= 1/2 * einsum('Zxyz,VW,XY,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/2 * einsum('Zxyz,VY,WX,Uxyz->UVXZWY', v_aaaa, np.identity(ncas), np.identity(ncas), rdm_ccaa, optimize = einsum_type)

    K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    # K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    # K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    K22[::2,1::2,::2,::2,1::2,::2] = K22_aab_aab.transpose(0,2,1,3,5,4).copy()
    K22[1::2,::2,1::2,1::2,::2,1::2] = K22[::2,1::2,::2,::2,1::2,::2].copy()

    K22[::2,1::2,::2,::2,::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    K22[1::2,::2,1::2,1::2,1::2,::2] = K22[::2,1::2,::2,::2,::2,1::2].copy()

    K22[::2,::2,1::2,::2,1::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,::2,1::2,::2,1::2] = K22[::2,::2,1::2,::2,1::2,::2].copy()

    K22[::2,::2,::2,1::2,1::2,::2]  = K22_aab_aab.copy()
    K22[::2,::2,::2,1::2,1::2,::2] -= K22_baa_baa.copy()
    K22[::2,::2,::2,1::2,1::2,::2] += K22[::2,1::2,::2,::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,::2,::2,1::2] = K22[::2,::2,::2,1::2,1::2,::2].copy()

    K22[1::2,1::2,::2,::2,::2,::2]  = K22_aab_aab.copy()
    K22[1::2,1::2,::2,::2,::2,::2] -= K22_baa_baa.copy()
    K22[1::2,1::2,::2,::2,::2,::2] += K22[::2,::2,1::2,::2,1::2,::2].copy()
    K22[::2,::2,1::2,1::2,1::2,1::2] = K22[1::2,1::2,::2,::2,::2,::2].copy()

    K22[1::2,::2,1::2,::2,::2,::2] -= K22[1::2,1::2,::2,::2,::2,::2].transpose(0,2,1,3,4,5).copy()
    K22[::2,1::2,::2,1::2,1::2,1::2] = K22[1::2,::2,1::2,::2,::2,::2].copy()

    K22[::2,::2,::2,1::2,::2,1::2] -= K22[::2,::2,::2,1::2,1::2,::2].transpose(0,1,2,3,5,4).copy()
    K22[1::2,1::2,1::2,::2,1::2,::2] = K22[::2,::2,::2,1::2,::2,1::2].copy()

    K22[::2,::2,::2,::2,::2,::2]  = K22[::2,::2,::2,1::2,1::2,::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,1::2,::2,1::2,::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,::2,1::2,1::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,1::2,1::2,1::2] = K22[::2,::2,::2,::2,::2,::2].copy()

    ###
    # # K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    # K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    # # K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    # # K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    # # K22[::2,1::2,::2,::2,1::2,::2] = K22_aab_aab.transpose(0,2,1,3,5,4).copy()
    # K22[1::2,::2,1::2,1::2,::2,1::2] = K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # # K22[::2,1::2,::2,::2,::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    # K22[1::2,::2,1::2,1::2,1::2,::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()

    # # K22[::2,::2,1::2,::2,1::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    # K22[1::2,1::2,::2,1::2,::2,1::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()

    # K22[::2,::2,::2,1::2,1::2,::2]  = K22_aab_aab.copy()
    # K22[::2,::2,::2,1::2,1::2,::2] -= K22_baa_baa.copy()
    # K22[::2,::2,::2,1::2,1::2,::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()

    # # K22[1::2,1::2,1::2,::2,::2,1::2]  = K22_aab_aab.copy()
    # # K22[1::2,1::2,1::2,::2,::2,1::2] -= K22_baa_baa.copy()
    # # K22[1::2,1::2,1::2,::2,::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()

    # K22[1::2,1::2,::2,::2,::2,::2]  = K22_aab_aab.copy()
    # K22[1::2,1::2,::2,::2,::2,::2] -= K22_baa_baa.copy()
    # K22[1::2,1::2,::2,::2,::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()

    # # K22[::2,::2,1::2,1::2,1::2,1::2]  = K22_aab_aab.copy()
    # # K22[::2,::2,1::2,1::2,1::2,1::2] -= K22_baa_baa.copy()
    # # K22[::2,::2,1::2,1::2,1::2,1::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()

    # K22[1::2,::2,1::2,::2,::2,::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    # K22[1::2,::2,1::2,::2,::2,::2] -= K22_baa_baa.copy()
    # K22[1::2,::2,1::2,::2,::2,::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # # K22[::2,1::2,::2,1::2,1::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    # # K22[::2,1::2,::2,1::2,1::2,1::2] -= K22_baa_baa.copy()
    # # K22[::2,1::2,::2,1::2,1::2,1::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # K22[::2,::2,::2,1::2,::2,1::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    # K22[::2,::2,::2,1::2,::2,1::2] -= K22_baa_baa.copy()
    # K22[::2,::2,::2,1::2,::2,1::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # # K22[1::2,1::2,1::2,::2,1::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    # # K22[1::2,1::2,1::2,::2,1::2,::2] -= K22_baa_baa.copy()
    # # K22[1::2,1::2,1::2,::2,1::2,::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # K22[::2,::2,::2,::2,::2,::2]  = K22_aab_aab.copy()
    # K22[::2,::2,::2,::2,::2,::2] -= K22_baa_baa.copy()
    # K22[::2,::2,::2,::2,::2,::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    # K22[::2,::2,::2,::2,::2,::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    # K22[::2,::2,::2,::2,::2,::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()

    # # K22[1::2,1::2,1::2,1::2,1::2,1::2]  = K22_aab_aab.copy()
    # # K22[1::2,1::2,1::2,1::2,1::2,1::2] -= K22_baa_baa.copy()
    # # K22[1::2,1::2,1::2,1::2,1::2,1::2] -= K22_aab_aab.transpose(0,2,1,3,4,5).copy()
    # # K22[1::2,1::2,1::2,1::2,1::2,1::2] -= K22_aab_aab.transpose(0,1,2,3,5,4).copy()
    # # K22[1::2,1::2,1::2,1::2,1::2,1::2] += K22_aab_aab.transpose(0,2,1,3,5,4).copy()
    ###

    K12 = K12[:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,:,:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,aa_ind[0],aa_ind[1]]

    K_p1p = np.zeros((dim_act, dim_act))

    K_p1p[:n_x,:n_x] = K11.copy()
    K_p1p[:n_x,n_x:] = K12.reshape(n_x, n_xzw).copy()
    K_p1p[n_x:,:n_x] = K12.reshape(n_x, n_xzw).T.copy()
    K_p1p[n_x:,n_x:] = K22.reshape(n_xzw, n_xzw).copy()

    return K_p1p

def compute_K_m1p_sanity_check(mr_adc):

    # Einsum definition from kernel
    einsum = mr_adc.interface.einsum
    einsum_type = mr_adc.interface.einsum_type

    # Variables from kernel
    ncas = mr_adc.ncas

    rdm_ca = mr_adc.rdm.ca
    rdm_ccaa = mr_adc.rdm.ccaa
    rdm_cccaaa = mr_adc.rdm.cccaaa
    rdm_ccccaaaa = mr_adc.rdm.ccccaaaa

    h_aa = mr_adc.h1eff.aa
    v_aaaa = mr_adc.v2e.aaaa

    n_x = ncas * 2
    n_xzw = ncas * 2 * ncas * 2 * (ncas * 2 - 1) // 2
    dim_act = n_x + n_xzw
    aa_ind = np.tril_indices(ncas * 2, k=-1)

    # Computing K11
    K11 = np.zeros((ncas * 2, ncas * 2))

    K11_a_a =- 1/2 * einsum('Yx,Xx->XY', h_aa, rdm_ca, optimize = einsum_type)
    K11_a_a -= 1/2 * einsum('Yxyz,Xxyz->XY', v_aaaa, rdm_ccaa, optimize = einsum_type)

    K11[::2,::2] = K11_a_a.copy()
    K11[1::2,1::2] = K11_a_a.copy()

    # Computing K12
    K12 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K12_a_abb =- 1/3 * einsum('Wx,XZYx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Wx,XZxY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('Yx,XZWx->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('Yx,XZxW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/6 * einsum('Zx,XxWY->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb += 1/3 * einsum('Zx,XxYW->XYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/6 * einsum('WYxy,XZxy->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/3 * einsum('WYxy,XZyx->XYWZ', v_aaaa, rdm_ccaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Wxyz,XZxYyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxYzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Wxyz,XZxyYz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxyzY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzYy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Wxyz,XZxzyY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Yxyz,XZxWyz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxWzy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/4 * einsum('Yxyz,XZxyWz->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxyzW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzWy->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Yxyz,XZxzyW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/12 * einsum('Zxyz,XyzWYx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzWxY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb += 1/4 * einsum('Zxyz,XyzYWx->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzYxW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxWY->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K12_a_abb -= 1/12 * einsum('Zxyz,XyzxYW->XYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K12[::2,::2,1::2,1::2] = K12_a_abb.copy()
    K12[1::2,1::2,::2,::2] = K12_a_abb.copy()

    K12[::2,1::2,::2,1::2] -= K12[::2,::2,1::2,1::2].transpose(0,2,1,3).copy()
    K12[1::2,::2,1::2,::2]  = K12[::2,1::2,::2,1::2].copy()

    K12[::2,::2,::2,::2]  = K12_a_abb.copy()
    K12[::2,::2,::2,::2] += K12[::2,1::2,::2,1::2].copy()
    K12[1::2,1::2,1::2,1::2] = K12[::2,::2,::2,::2].copy()

    # Computing K22
    K22 = np.zeros((ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2, ncas * 2))

    K22_aab_aab  = 1/6 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,UXZYxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,UXZWxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Zx,UXxWYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VxyZ,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/8 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/8 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 2/15 * einsum('Wxyz,UXZxVYyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UXZxVYzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 11/40 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/60 * einsum('Wxyz,UXZxVyzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/24 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Wxyz,UXZxVzyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/20 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/10 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/40 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Wxyz,UXZxyYzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Wxyz,UXZxyzYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Wxyz,UXZxzVyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 3/40 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 2/15 * einsum('Yxyz,UXZxVWyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UXZxVWzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 11/40 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Yxyz,UXZxVyzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/24 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Yxyz,UXZxVzyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/10 * einsum('Yxyz,UXZxWyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Yxyz,UXZxWyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Yxyz,UXZxWzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Yxyz,UXZxWzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Yxyz,UXZxyzWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/30 * einsum('Yxyz,UXZxzVyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/20 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/40 * einsum('Yxyz,UXZxzyWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Zxyz,UXyzVWYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UXyzVWxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/15 * einsum('Zxyz,UXyzVYWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UXyzVYxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/60 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 9/40 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/10 * einsum('Zxyz,UXyzWYVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 3/20 * einsum('Zxyz,UXyzWYxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/5 * einsum('Zxyz,UXyzWxVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 7/60 * einsum('Zxyz,UXyzWxYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/120 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/20 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/10 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/30 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 7/120 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab -= 1/40 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/40 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab -= 1/6 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_aab_aab += 1/6 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22_baa_baa  = 1/3 * einsum('VZ,UXWY->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VZ,UXYW->XUVYWZ', h_aa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,UXZVYx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UXZVxY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Wx,UXZYVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Wx,UXZxYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Yx,UXZVxW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UXZWVx->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yx,UXZWxV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Yx,UXZxWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zx,UXxVYW->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UXxWVY->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Zx,UXxWYV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('Zx,UXxYWV->XUVYWZ', h_aa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VWxy,UXZYxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VWxy,UXZYyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VWxy,UXZxYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VWxy,UXZxyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VWxy,UXZyYx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VWxy,UXZyxY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VYxy,UXZWxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('VYxy,UXZWyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VYxy,UXZxWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('VYxy,UXZxyW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('VYxy,UXZyWx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('VYxy,UXZyxW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/3 * einsum('VxZy,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('VxZy,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VxyZ,UXxWYy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyZ,UXxWyY->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VxyZ,UXxYWy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VxyZ,UXxyYW->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UXZVxy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/8 * einsum('WYxy,UXZVyx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UXZxVy->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('WYxy,UXZxyV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('WYxy,UXZyVx->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('WYxy,UXZyxV->XUVYWZ', v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 3/10 * einsum('Wxyz,UXZxVYyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UXZxVYzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/20 * einsum('Wxyz,UXZxVyYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UXZxVyzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Wxyz,UXZxVzYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Wxyz,UXZxVzyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/40 * einsum('Wxyz,UXZxYVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Wxyz,UXZxYVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 2/15 * einsum('Wxyz,UXZxYyVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Wxyz,UXZxYyzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/30 * einsum('Wxyz,UXZxYzVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 7/60 * einsum('Wxyz,UXZxYzyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/40 * einsum('Wxyz,UXZxyVYz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Wxyz,UXZxyVzY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Wxyz,UXZxyzVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/120 * einsum('Wxyz,UXZxzVYy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 3/40 * einsum('Wxyz,UXZxzVyY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Wxyz,UXZxzYVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Wxyz,UXZxzYyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Wxyz,UXZxzyVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Wxyz,UXZxzyYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/6 * einsum('Yxyz,UXZxVWzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Yxyz,UXZxVyWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Yxyz,UXZxVyzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/20 * einsum('Yxyz,UXZxVzWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 7/40 * einsum('Yxyz,UXZxVzyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/120 * einsum('Yxyz,UXZxWVyz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Yxyz,UXZxWVzy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 11/120 * einsum('Yxyz,UXZxyVWz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UXZxyVzW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Yxyz,UXZxyWVz->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxyWzV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Yxyz,UXZxyzVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/40 * einsum('Yxyz,UXZxzVWy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Yxyz,UXZxzVyW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxzWVy->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Yxyz,UXZxzWyV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/40 * einsum('Yxyz,UXZxzyVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 2/15 * einsum('Zxyz,UXyzVWYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/30 * einsum('Zxyz,UXyzVWxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 3/10 * einsum('Zxyz,UXyzVYWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UXyzVYxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/20 * einsum('Zxyz,UXyzVxWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/10 * einsum('Zxyz,UXyzVxYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/15 * einsum('Zxyz,UXyzWVYx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/60 * einsum('Zxyz,UXyzWVxY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 11/40 * einsum('Zxyz,UXyzYVWx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/24 * einsum('Zxyz,UXyzYVxW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Zxyz,UXyzYWVx->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/24 * einsum('Zxyz,UXyzYWxV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/40 * einsum('Zxyz,UXyzYxVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/8 * einsum('Zxyz,UXyzYxWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('Zxyz,UXyzxVWY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/15 * einsum('Zxyz,UXyzxVYW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UXyzxWVY->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/60 * einsum('Zxyz,UXyzxWYV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/20 * einsum('Zxyz,UXyzxYVW->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa += 1/10 * einsum('Zxyz,UXyzxYWV->XUVYWZ', v_aaaa, rdm_ccccaaaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Wx,VZ,UXYx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Wx,VZ,UXxY->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('Yx,VZ,UXWx->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('Yx,VZ,UXxW->XUVYWZ', h_aa, np.identity(ncas), rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/3 * einsum('VZ,WYxy,UXxy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/6 * einsum('VZ,WYxy,UXyx->XUVYWZ', np.identity(ncas), v_aaaa, rdm_ccaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VZ,Wxyz,UXxYyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxYzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VZ,Wxyz,UXxyYz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxyzY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxzYy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Wxyz,UXxzyY->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/4 * einsum('VZ,Yxyz,UXxWyz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxWzy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa -= 1/12 * einsum('VZ,Yxyz,UXxyWz->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxyzW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxzWy->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)
    K22_baa_baa += 1/12 * einsum('VZ,Yxyz,UXxzyW->XUVYWZ', np.identity(ncas), v_aaaa, rdm_cccaaa, optimize = einsum_type)

    K22[::2,::2,1::2,::2,::2,1::2] = K22_aab_aab.copy()
    K22[1::2,1::2,::2,1::2,1::2,::2] = K22_aab_aab.copy()

    K22[1::2,::2,::2,1::2,::2,::2] = K22_baa_baa.copy()
    K22[::2,1::2,1::2,::2,1::2,1::2] = K22_baa_baa.copy()

    K22[1::2,::2,::2,::2,1::2,::2] -= K22_baa_baa.transpose(0,1,2,4,3,5).copy()
    K22[::2,1::2,1::2,1::2,::2,1::2] = K22[1::2,::2,::2,::2,1::2,::2].copy()

    K22[::2,1::2,::2,1::2,::2,::2] -= K22_baa_baa.transpose(1,0,2,3,4,5).copy()
    K22[1::2,::2,1::2,::2,1::2,1::2] = K22[::2,1::2,::2,1::2,::2,::2].copy()

    K22[::2,1::2,::2,::2,1::2,::2] = K22_baa_baa.transpose(1,0,2,4,3,5).copy()
    K22[1::2,::2,1::2,1::2,::2,1::2] = K22[::2,1::2,::2,::2,1::2,::2].copy()

    K22[::2,::2,::2,::2,1::2,1::2]  = K22_baa_baa.copy()
    K22[::2,::2,::2,::2,1::2,1::2] -= K22_aab_aab.copy()
    K22[::2,::2,::2,::2,1::2,1::2] += K22[::2,1::2,::2,1::2,::2,::2].copy()
    K22[1::2,1::2,1::2,1::2,::2,::2] = K22[::2,::2,::2,::2,1::2,1::2].copy()

    K22[::2,::2,::2,1::2,::2,1::2] -= K22[::2,::2,::2,::2,1::2,1::2].transpose(0,1,2,4,3,5).copy()
    K22[1::2,1::2,1::2,::2,1::2,::2] = K22[::2,::2,::2,1::2,::2,1::2].copy()

    K22[::2,1::2,1::2,::2,::2,::2]  = K22_baa_baa.copy()
    K22[::2,1::2,1::2,::2,::2,::2] -= K22_aab_aab.copy()
    K22[::2,1::2,1::2,::2,::2,::2] += K22[1::2,::2,::2,::2,1::2,::2].copy()
    K22[1::2,::2,::2,1::2,1::2,1::2] = K22[::2,1::2,1::2,::2,::2,::2].copy()

    K22[1::2,::2,1::2,::2,::2,::2] -= K22[::2,1::2,1::2,::2,::2,::2].transpose(1,0,2,3,4,5).copy()
    K22[::2,1::2,::2,1::2,1::2,1::2] = K22[1::2,::2,1::2,::2,::2,::2].copy()

    K22[::2,::2,::2,::2,::2,::2]  = K22[::2,::2,::2,::2,1::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[::2,1::2,1::2,1::2,::2,1::2].copy()
    K22[::2,::2,::2,::2,::2,::2] += K22[1::2,::2,1::2,1::2,::2,1::2].copy()
    K22[1::2,1::2,1::2,1::2,1::2,1::2] = K22[::2,::2,::2,::2,::2,::2].copy()

    K12 = K12[:,aa_ind[0],aa_ind[1]]
    K22 = K22[:,:,:,aa_ind[0],aa_ind[1]]
    K22 = K22[aa_ind[0],aa_ind[1]]

    K_m1p = np.zeros((dim_act, dim_act))

    K_m1p[:n_x,:n_x] = K11.copy()
    K_m1p[:n_x,n_x:] = K12.reshape(n_x, n_xzw).copy()
    K_m1p[n_x:,:n_x] = K12.reshape(n_x, n_xzw).T.copy()
    K_m1p[n_x:,n_x:] = K22.reshape(n_xzw, n_xzw).copy()

    return K_m1p

## Under Development
